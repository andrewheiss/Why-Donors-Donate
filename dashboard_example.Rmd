---
title: "Example of Market Simulator Dasbhaord"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: scroll
runtime: shiny
---

```{r load-packages, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(tidyverse)
library(flexdashboard)
library(plotly)
library(shiny)
```

```{r load-data, message=FALSE}
# Gammas of the "everything" model
gammas <- read_rds(
    here::here('analysis', 'output', 'posterior_draws', 'public_political_social_charity_demo.rds')
  ) %>% 
  group_by(i, j) %>% 
  summarize(gamma_mean = mean(Gamma)) %>% 
  ungroup() %>% 
  pivot_wider(names_from = j, values_from = gamma_mean) %>% 
  select(-i) %>% 
  t()

# Default configurations
prod_default <- read_csv(
    here::here('analysis', 'output', 'configurations', 'org_data_default.csv')
  )
per_default <- read_csv(
    here::here('analysis', 'output', 'configurations', 'per_data_default.csv')
  )
```

```{r prod-reactive-table}
# Assign level labels
org_table <- data.frame(
  levels = c(
    # Organization
    "Amnesty International",
    "Greenpeace", 
    "Oxfam", 
    "Red Cross",
    # Issue area
    "Environment", 
    "Human rights",
    "Refugee relief",
    # Financial transparency
    "Engages in financial transparency",
    # Financial accountability
    "Engages in financial accountability",
    # Funding sources
    "Handful of wealthy private donors", 
    "Government grants",
    # Relationship with host government
    "Criticized by government",
    "Under government crackdown"
  )
)

# prod configuration reactive element
prod_reactive <- reactive({
  # prod 1
  org_table$org1_value <- 0
  org_table$org1_value[org_table$levels %in% input$org1_org] <- 1
  org_table$org1_value[org_table$levels %in% input$org1_issue] <- 1
  org_table$org1_value[org_table$levels %in% input$org1_fin_trans] <- 1
  org_table$org1_value[org_table$levels %in% input$org1_fin_account] <- 1
  org_table$org1_value[org_table$levels %in% input$org1_funding] <- 1
  org_table$org1_value[org_table$levels %in% input$org1_host_gov] <- 1
    
  # prod 2
  org_table$org2_value <- 0
  org_table$org2_value[org_table$levels %in% input$org2_org] <- 1
  org_table$org2_value[org_table$levels %in% input$org2_issue] <- 1
  org_table$org2_value[org_table$levels %in% input$org2_fin_trans] <- 1
  org_table$org2_value[org_table$levels %in% input$org2_fin_account] <- 1
  org_table$org2_value[org_table$levels %in% input$org2_funding] <- 1
  org_table$org2_value[org_table$levels %in% input$org2_host_gov] <- 1
    
  # prod 3
  org_table$org3_value <- 0
  org_table$org3_value[org_table$levels %in% input$org3_org] <- 1
  org_table$org3_value[org_table$levels %in% input$org3_issue] <- 1
  org_table$org3_value[org_table$levels %in% input$org3_fin_trans] <- 1
  org_table$org3_value[org_table$levels %in% input$org3_fin_account] <- 1
  org_table$org3_value[org_table$levels %in% input$org3_funding] <- 1
  org_table$org3_value[org_table$levels %in% input$org3_host_gov] <- 1
    
  # prod 4
  org_table$org4_value <- 0
  org_table$org4_value[org_table$levels %in% input$org4_org] <- 1
  org_table$org4_value[org_table$levels %in% input$org4_issue] <- 1
  org_table$org4_value[org_table$levels %in% input$org4_fin_trans] <- 1
  org_table$org4_value[org_table$levels %in% input$org4_fin_account] <- 1
  org_table$org4_value[org_table$levels %in% input$org4_funding] <- 1
  org_table$org4_value[org_table$levels %in% input$org4_host_gov] <- 1
  org_table
})
```

```{r persona-reactive-table}
# Assign covariate labels
per_table <- data.frame(
  levels = c(
    # Intercept
    "Intercept",
    # Mediums to follow news
    "TV",
    "Print",
    "Online (not social media)",
    "Social media",
    "Radio",
    "Email newsletter",
    "News app",
    # Gender
    "Female",
    "Transgender",
    "Prefer not to say",
    "Other gender",
    # Marital status
    "Widowed",
    "Divorced",
    "Separated",
    "Never married",
    # Education
    "High school graduate", 
    "Some college",
    "2 year degree",
    "4 year degree",
    "Graduate or professional degree",
    "Doctorate",
    # Income
    "More than median of $61,372", 
    # Race
    "White", 
    "Black or African American", 
    "American Indian or Alaskan Native", 
    "Asian", 
    "Native Hawaiian or Pacific Islander",
    "Other race",
    # Age
    "More than median age of 36"
  )
)

## Test to subset the data
per_join <- per_default %>% inner_join(per_table, by = "levels")

# Persona configuration reactive element
per_reactive <- reactive({
  # Persona 1
  per_table$per1_value <- 0
  per_table$per1_value[per_table$levels == 'Intercept'] <- 1
  per_table$per1_value[per_table$levels %in% input$per1_news_medium] <- 1
  per_table$per1_value[per_table$levels %in% input$per1_gender] <- 1
  per_table$per1_value[per_table$levels %in% input$per1_marital_status] <- 1
  per_table$per1_value[per_table$levels %in% input$per1_education] <- 1
  per_table$per1_value[per_table$levels %in% input$per1_income] <- 1
  per_table$per1_value[per_table$levels %in% input$per1_race] <- 1
  per_table$per1_value[per_table$levels %in% input$per1_age] <- 1
    
  # Persona 2
  per_table$per2_value <- 0
  per_table$per2_value[per_table$levels == 'Intercept'] <- 1
  per_table$per2_value[per_table$levels %in% input$per2_gender] <- 1
  per_table$per2_value[per_table$levels %in% input$per2_marital_status] <- 1
  per_table$per2_value[per_table$levels %in% input$per2_education] <- 1
  per_table$per2_value[per_table$levels %in% input$per2_income] <- 1
  per_table$per2_value[per_table$levels %in% input$per2_race] <- 1
  per_table$per2_value[per_table$levels %in% input$per2_age] <- 1
    
  # Persona 3
  per_table$per3_value <- 0
  per_table$per3_value[per_table$levels == 'Intercept'] <- 1
  per_table$per3_value[per_table$levels %in% input$per3_news_medium] <- 1
  per_table$per3_value[per_table$levels %in% input$per3_gender] <- 1
  per_table$per3_value[per_table$levels %in% input$per3_marital_status] <- 1
  per_table$per3_value[per_table$levels %in% input$per3_education] <- 1
  per_table$per3_value[per_table$levels %in% input$per3_income] <- 1
  per_table$per3_value[per_table$levels %in% input$per3_race] <- 1
  per_table$per3_value[per_table$levels %in% input$per3_age] <- 1
  per_table
})
```

Market share
-------------------------------------------------

```{r compute-and-plot}
# Compute and render the market share plot
renderPlotly({
  org_choice = org_reactive()
  per_choice = per_reactive()
    
  # Persona 1 predicted betas
  per1_betas <- as.matrix(gammas) %*% as.matrix(per_choice[,2])
  
  # Persona 1 expected utilities
  per1_org1_exp <- exp(t(org_choice[,2]) %*% as.matrix(per1_betas))
  per1_org2_exp <- exp(t(org_choice[,3]) %*% as.matrix(per1_betas))
  per1_org3_exp <- exp(t(org_choice[,4]) %*% as.matrix(per1_betas))
  per1_org4_exp <- exp(t(org_choice[,5]) %*% as.matrix(per1_betas))
  
  # Persona 1 market shares
  per1_share_denom <- sum(per1_org1_exp, per1_org2_exp, per1_org3_exp, per1_org4_exp)
  per1_org1_share <- 100 * (per1_org1_exp / per1_share_denom)
  per1_org2_share <- 100 * (per1_org2_exp / per1_share_denom)
  per1_org3_share <- 100 * (per1_org3_exp / per1_share_denom)
  per1_org4_share <- 100 * (per1_org4_exp / per1_share_denom)
  
  # Persona 2 predicted betas
  per2_betas <- as.matrix(gammas) %*% as.matrix(per_choice[,3])
  
  # Persona 2 expected utilities
  per2_org1_exp <- exp(t(org_choice[,2]) %*% as.matrix(per2_betas))
  per2_org2_exp <- exp(t(org_choice[,3]) %*% as.matrix(per2_betas))
  per2_org3_exp <- exp(t(org_choice[,4]) %*% as.matrix(per2_betas))
  per2_org4_exp <- exp(t(org_choice[,5]) %*% as.matrix(per2_betas))
  
  # Persona 2 market shares
  per2_share_denom <- sum(per2_org1_exp, per2_org2_exp, per2_org3_exp, per2_org4_exp)
  per2_org1_share <- 100 * (per2_org1_exp / per2_share_denom)
  per2_org2_share <- 100 * (per2_org2_exp / per2_share_denom)
  per2_org3_share <- 100 * (per2_org3_exp / per2_share_denom)
  per2_org4_share <- 100 * (per2_org4_exp / per2_share_denom)
  
  # Persona 3 predicted betas
  per3_betas <- as.matrix(gammas) %*% as.matrix(per_choice[,4])
  
  # Persona 3 expected utilities
  per3_org1_exp <- exp(t(org_choice[,2]) %*% as.matrix(per3_betas))
  per3_org2_exp <- exp(t(org_choice[,3]) %*% as.matrix(per3_betas))
  per3_org3_exp <- exp(t(org_choice[,4]) %*% as.matrix(per3_betas))
  per3_org4_exp <- exp(t(org_choice[,5]) %*% as.matrix(per3_betas))
  
  # Persona 3 market shares
  per3_share_denom <- sum(per3_org1_exp, per3_org2_exp, per3_org3_exp, per3_org4_exp)
  per3_org1_share <- 100 * (per3_org1_exp / per3_share_denom)
  per3_org2_share <- 100 * (per3_org2_exp / per3_share_denom)
  per3_org3_share <- 100 * (per3_org3_exp / per3_share_denom)
  per3_org4_share <- 100 * (per3_org4_exp / per3_share_denom)
  
  # Data for plotly
  plot_data <- data.frame(
    Value = c(
      # Persona 1
      per1_org1_share, per1_org2_share, per1_org3_share, per1_org4_share, 
      # Persona 2
      per2_org1_share, per2_org2_share, per2_org3_share, per2_org4_share,
      # Persona 3
      per3_org1_share, per3_org2_share, per3_org3_share, per3_org4_share
    ),
    Product = c(input$org1_name, input$org2_name, input$org3_name, input$org4_name),
    Persona = c(
      rep(input$per1_name, 4), 
      rep(input$per2_name, 4), 
      rep(input$per3_name, 4)
    )
  )
  
  ggplotly(
    plot_data %>% 
      # Factor Product and Persona with ordered=TRUE
      mutate(
        Product = factor(
          Product, 
          levels = c(input$org1_name, input$org2_name, input$org3_name, input$org4_name), 
          ordered = TRUE
        ),
        Persona = factor(
          Persona, 
          levels = c(input$per1_name, input$per2_name, input$per3_name), 
          ordered = TRUE
        )
      ) %>% 
      ggplot(aes(y = Value, x = Product, fill = Persona)) +
      geom_bar(position = "dodge", stat = "identity") +
      labs(x="", y = "Market Share") + 
      scale_fill_manual(values = c("#FFC30B", "#28a153", "#c23838")) +
      theme(
        legend.position = "right",
        panel.background = element_blank(),
        panel.grid.major.y = element_line(color = "#D3D3D3")
      )
    )
})

# Compute and render the market share as a table
renderTable({
  org_choice = org_reactive()
  per_choice = per_reactive()
    
  # Persona 1 predicted betas
  per1_betas <- as.matrix(gammas) %*% as.matrix(per_choice[,2])
  
  # Persona 1 expected utilities
  per1_org1_exp <- exp(t(org_choice[,2]) %*% as.matrix(per1_betas))
  per1_org2_exp <- exp(t(org_choice[,3]) %*% as.matrix(per1_betas))
  per1_org3_exp <- exp(t(org_choice[,4]) %*% as.matrix(per1_betas))
  per1_org4_exp <- exp(t(org_choice[,5]) %*% as.matrix(per1_betas))
  
  # Persona 1 market shares
  per1_share_denom <- sum(per1_org1_exp, per1_org2_exp, per1_org3_exp, per1_org4_exp)
  per1_org1_share <- 100 * (per1_org1_exp / per1_share_denom)
  per1_org2_share <- 100 * (per1_org2_exp / per1_share_denom)
  per1_org3_share <- 100 * (per1_org3_exp / per1_share_denom)
  per1_org4_share <- 100 * (per1_org4_exp / per1_share_denom)
  
  # Persona 2 predicted betas
  per2_betas <- as.matrix(gammas) %*% as.matrix(per_choice[,3])
  
  # Persona 2 expected utilities
  per2_org1_exp <- exp(t(org_choice[,2]) %*% as.matrix(per2_betas))
  per2_org2_exp <- exp(t(org_choice[,3]) %*% as.matrix(per2_betas))
  per2_org3_exp <- exp(t(org_choice[,4]) %*% as.matrix(per2_betas))
  per2_org4_exp <- exp(t(org_choice[,5]) %*% as.matrix(per2_betas))
  
  # Persona 2 market shares
  per2_share_denom <- sum(per2_org1_exp, per2_org2_exp, per2_org3_exp, per2_org4_exp)
  per2_org1_share <- 100 * (per2_org1_exp / per2_share_denom)
  per2_org2_share <- 100 * (per2_org2_exp / per2_share_denom)
  per2_org3_share <- 100 * (per2_org3_exp / per2_share_denom)
  per2_org4_share <- 100 * (per2_org4_exp / per2_share_denom)
  
  # Persona 3 predicted betas
  per3_betas <- as.matrix(gammas) %*% as.matrix(per_choice[,4])
  
  # Persona 3 expected utilities
  per3_org1_exp <- exp(t(org_choice[,2]) %*% as.matrix(per3_betas))
  per3_org2_exp <- exp(t(org_choice[,3]) %*% as.matrix(per3_betas))
  per3_org3_exp <- exp(t(org_choice[,4]) %*% as.matrix(per3_betas))
  per3_org4_exp <- exp(t(org_choice[,5]) %*% as.matrix(per3_betas))
  
  # Persona 3 market shares
  per3_share_denom <- sum(per3_org1_exp, per3_org2_exp, per3_org3_exp, per3_org4_exp)
  per3_org1_share <- 100 * (per3_org1_exp / per3_share_denom)
  per3_org2_share <- 100 * (per3_org2_exp / per3_share_denom)
  per3_org3_share <- 100 * (per3_org3_exp / per3_share_denom)
  per3_org4_share <- 100 * (per3_org4_exp / per3_share_denom)
  
  # Table
  data <- data.frame(
    Shares = c(
      # Persona 1
      per1_org1_share, per1_org2_share, per1_org3_share, per1_org4_share, 
      # Persona 2
      per2_org1_share, per2_org2_share, per2_org3_share, per2_org4_share,
      # Persona 3
      per3_org1_share, per3_org2_share, per3_org3_share, per3_org4_share
    ),
    Product = c(input$org1_name, input$org2_name, input$org3_name, input$org4_name),
    Persona = c(
      rep(input$per1_name, 4), 
      rep(input$per2_name, 4), 
      rep(input$per3_name, 4)
    )
  ) %>% 
    pivot_wider(names_from = Persona, values_from = Shares)
  
  data
})
```


Configurations
-------------------------------------------------

### Product 1

```{r org1-inputs}
# Naming
textInput(
  "org1_name",
  label = "Product Name:",
  value = "Product 1",
  placeholder = "Enter Product Name",
  width = "450px"
)

# Product
renderUI({
  org_data = product_data()
  selectInput(
    "org1_org",
    label = "Product:",
    choice = c("Amnesty International", "Greenpeace", "Oxfam", "Red Cross"),
    # selected = "Red Cross",
    selected = as.character(org_data[1:4,][which(org_data[1:4,2] == 1), 1]),
    width = "450px"
  )
})

# Issue area
renderUI({
  org_data = product_data()
  selectInput(
    "org1_issue", 
    label = "Issue Area:",
    choices = c("Emergency response", "Environment", "Human rights", "Refugee relief"),
    # selected = "Emergency response",
    selected = ifelse(
      sum(org_data[5:7,2]) == 0, "Emergency response",
      as.character(org_data[5:7,][which(org_data[5:7,2] == 1), 1])
    ),
    width = "450px"
  )
})

# Financial transparency
renderUI({
  org_data = product_data()
  selectInput(
    "org1_fin_trans",
    label = "Financial Transparency:",
    choices = c(
      "Doesn’t engage in financial transparency", 
      "Engages in financial transparency"
    ),
    # selected = "Engages in financial transparency",
    selected = ifelse(
      sum(org_data[8,2]) == 0, "Doesn’t engage in financial transparency",
      as.character(org_data[8,][which(org_data[8,2] == 1), 1])
    ),
    width = "450px"
  )
})

# Financial accountability
renderUI({
  org_data = product_data()
  selectInput(
    "org1_fin_account",
    label = "Financial Accountability:",
    choices = c(
      "Doesn’t engage in financial accountability", 
      "Engages in financial accountability"
    ),
    # selected = "Engages in financial accountability",
    selected = ifelse(
      sum(org_data[9,2]) == 0, "Doesn’t engage in financial accountability",
      as.character(org_data[9,][which(org_data[9,2] == 1), 1])
    ),
    width = "450px"
  )
})

# Funding sources
renderUI({
  org_data = product_data()
  selectInput(
    "org1_funding",
    label = "Funding Source:",
    choices = c(
      "Many small private donations", 
      "Handful of wealthy private donors", 
      "Government grants"
    ),
    # selected = "Many small private donations",
    selected = ifelse(
      sum(org_data[10:11,2]) == 0, "Many small private donations",
      as.character(org_data[10:11,][which(org_data[10:11,2] == 1), 1])
    ),
    width = "450px"
  )
})

# Relationship with host government
renderUI({
  org_data = product_data()
  selectInput(
    "org1_host_gov",
    label = "Relationship With Host Government",
    choices = c(
      "Friendly relationship with government", 
      "Criticized by government",  
      "Under government crackdown"
    ),
    # selected = "Friendly relationship with government",
    selected = ifelse(
      sum(org_data[12:13,2]) == 0, "Friendly relationship with government",
      as.character(org_data[12:13,][which(org_data[12:13,2] == 1), 1])
    ),
    width = "450px"
  )
})
```

### Product 2

```{r org2-inputs}
# Naming
textInput(
  "org2_name",
  label = "Product Name:",
  value = "Product 2",
  placeholder = "Enter Product Name",
  width = "450px"
)

# Product
renderUI({
  org_data = product_data()
  selectInput(
    "org2_org",
    label = "Product:",
    choice = c("Amnesty International", "Greenpeace", "Oxfam", "Red Cross"),
    # selected = "Red Cross",
    selected = as.character(org_data[1:4,][which(org_data[1:4,3] == 1), 1]),
    width = "450px"
  )
})

# Issue area
renderUI({
  org_data = product_data()
  selectInput(
    "org2_issue", 
    label = "Issue Area:",
    choices = c("Emergency response", "Environment", "Human rights", "Refugee relief"),
    # selected = "Environment",
    selected = ifelse(
      sum(org_data[5:7,3]) == 0, "Emergency response",
      as.character(org_data[5:7,][which(org_data[5:7,3] == 1), 1])
    ),
    width = "450px"
  )
})

# Financial transparency
renderUI({
  org_data = product_data()
  selectInput(
    "org2_fin_trans",
    label = "Financial Transparency:",
    choices = c(
      "Doesn’t engage in financial transparency", 
      "Engages in financial transparency"
    ),
    # selected = "Engages in financial transparency",
    selected = ifelse(
      sum(org_data[8,3]) == 0, "Doesn’t engage in financial transparency",
      as.character(org_data[8,][which(org_data[8,3] == 1), 1])
    ),
    width = "450px"
  )
})

# Financial accountability
renderUI({
  org_data = product_data()
  selectInput(
    "org2_fin_account",
    label = "Financial Accountability:",
    choices = c(
      "Doesn’t engage in financial accountability", 
      "Engages in financial accountability"
    ),
    # selected = "Engages in financial accountability",
    selected = ifelse(
      sum(org_data[9,3]) == 0, "Doesn’t engage in financial accountability",
      as.character(org_data[9,][which(org_data[9,3] == 1), 1])
    ),
    width = "450px"
  )
})

# Funding sources
renderUI({
  org_data = product_data()
  selectInput(
    "org2_funding",
    label = "Funding Source:",
    choices = c(
      "Many small private donations", 
      "Handful of wealthy private donors", 
      "Government grants"
    ),
    # selected = "Many small private donations",
    selected = ifelse(
      sum(org_data[10:11,3]) == 0, "Many small private donations",
      as.character(org_data[10:11,][which(org_data[10:11,3] == 1), 1])
    ),
    width = "450px"
  )
})

# Relationship with host government
renderUI({
  org_data = product_data()
  selectInput(
    "org2_host_gov",
    label = "Relationship With Host Government",
    choices = c(
      "Friendly relationship with government", 
      "Criticized by government",  
      "Under government crackdown"
    ),
    # selected = "Friendly relationship with government",
    selected = ifelse(
      sum(org_data[12:13,3]) == 0, "Friendly relationship with government",
      as.character(org_data[12:13,][which(org_data[12:13,3] == 1), 1])
    ),
    width = "450px"
  )
})
```

### Product 3

```{r org3-inputs}
# Naming
textInput(
  "org3_name",
  label = "Product Name:",
  value = "Product 3",
  placeholder = "Enter Product Name",
  width = "450px"
)

# Product
renderUI({
  org_data = product_data()
  selectInput(
    "org3_org",
    label = "Product:",
    choice = c("Amnesty International", "Greenpeace", "Oxfam", "Red Cross"),
    # selected = "Red Cross",
    selected = as.character(org_data[1:4,][which(org_data[1:4,4] == 1), 1]),
    width = "450px"
  )
})

# Issue area
renderUI({
  org_data = product_data()
  selectInput(
    "org3_issue", 
    label = "Issue Area:",
    choices = c("Emergency response", "Environment", "Human rights", "Refugee relief"),
    # selected = "Human rights",
    selected = ifelse(
      sum(org_data[5:7,4]) == 0, "Emergency response",
      as.character(org_data[5:7,][which(org_data[5:7,4] == 1), 1])
    ),
    width = "450px"
  )
})

# Financial transparency
renderUI({
  org_data = product_data()
  selectInput(
    "org3_fin_trans",
    label = "Financial Transparency:",
    choices = c(
      "Doesn’t engage in financial transparency", 
      "Engages in financial transparency"
    ),
    # selected = "Engages in financial transparency",
    selected = ifelse(
      sum(org_data[8,4]) == 0, "Doesn’t engage in financial transparency",
      as.character(org_data[8,][which(org_data[8,4] == 1), 1])
    ),
    width = "450px"
  )
})

# Financial accountability
renderUI({
  org_data = product_data()
  selectInput(
    "org3_fin_account",
    label = "Financial Accountability:",
    choices = c(
      "Doesn’t engage in financial accountability", 
      "Engages in financial accountability"
    ),
    # selected = "Engages in financial accountability",
    selected = ifelse(
      sum(org_data[9,4]) == 0, "Doesn’t engage in financial accountability",
      as.character(org_data[9,][which(org_data[9,4] == 1), 1])
    ),
    width = "450px"
  )
})

# Funding sources
renderUI({
  org_data = product_data()
  selectInput(
    "org3_funding",
    label = "Funding Source:",
    choices = c(
      "Many small private donations", 
      "Handful of wealthy private donors", 
      "Government grants"
    ),
    # selected = "Many small private donations",
    selected = ifelse(
      sum(org_data[10:11,4]) == 0, "Many small private donations",
      as.character(org_data[10:11,][which(org_data[10:11,4] == 1), 1])
    ),
    width = "450px"
  )
})

# Relationship with host government
renderUI({
  org_data = product_data()
  selectInput(
    "org3_host_gov",
    label = "Relationship With Host Government",
    choices = c(
      "Friendly relationship with government", 
      "Criticized by government",  
      "Under government crackdown"
    ),
    # selected = "Friendly relationship with government",
    selected = ifelse(
      sum(org_data[12:13,4]) == 0, "Friendly relationship with government",
      as.character(org_data[12:13,][which(org_data[12:13,4] == 1), 1])
    ),
    width = "450px"
  )
})
```

### Product 4

```{r org4-inputs}
# Naming
textInput(
  "org4_name",
  label = "Product Name:",
  value = "Product 4",
  placeholder = "Enter Product Name",
  width = "450px"
)

# Product
renderUI({
  org_data = product_data()
  selectInput(
    "org4_org",
    label = "Product:",
    choice = c("Amnesty International", "Greenpeace", "Oxfam", "Red Cross"),
    # selected = "Red Cross",
    selected = as.character(org_data[1:4,][which(org_data[1:4,5] == 1), 1]),
    width = "450px"
  )
})

# Issue area
renderUI({
  org_data = product_data()
  selectInput(
    "org4_issue", 
    label = "Issue Area:",
    choices = c("Emergency response", "Environment", "Human rights", "Refugee relief"),
    # selected = "Refugee relief",
    selected = ifelse(
      sum(org_data[5:7,5]) == 0, "Emergency response",
      as.character(org_data[5:7,][which(org_data[5:7,5] == 1), 1])
    ),
    width = "450px"
  )
})

# Financial transparency
renderUI({
  org_data = product_data()
  selectInput(
    "org4_fin_trans",
    label = "Financial Transparency:",
    choices = c(
      "Doesn’t engage in financial transparency", 
      "Engages in financial transparency"
    ),
    # selected = "Engages in financial transparency",
    selected = ifelse(
      sum(org_data[8,5]) == 0, "Doesn’t engage in financial transparency",
      as.character(org_data[8,][which(org_data[8,5] == 1), 1])
    ),
    width = "450px"
  )
})

# Financial accountability
renderUI({
  org_data = product_data()
  selectInput(
    "org4_fin_account",
    label = "Financial Accountability:",
    choices = c(
      "Doesn’t engage in financial accountability", 
      "Engages in financial accountability"
    ),
    # selected = "Engages in financial accountability",
    selected = ifelse(
      sum(org_data[9,5]) == 0, "Doesn’t engage in financial accountability",
      as.character(org_data[9,][which(org_data[9,5] == 1), 1])
    ),
    width = "450px"
  )
})

# Funding sources
renderUI({
  org_data = product_data()
  selectInput(
    "org4_funding",
    label = "Funding Source:",
    choices = c(
      "Many small private donations", 
      "Handful of wealthy private donors", 
      "Government grants"
    ),
    # selected = "Many small private donations",
    selected = ifelse(
      sum(org_data[10:11,5]) == 0, "Many small private donations",
      as.character(org_data[10:11,][which(org_data[10:11,5] == 1), 1])
    ),
    width = "450px"
  )
})

# Relationship with host government
renderUI({
  org_data = product_data()
  selectInput(
    "org4_host_gov",
    label = "Relationship With Host Government",
    choices = c(
      "Friendly relationship with government", 
      "Criticized by government",  
      "Under government crackdown"
    ),
    # selected = "Friendly relationship with government",
    selected = ifelse(
      sum(org_data[12:13,5]) == 0, "Friendly relationship with government",
      as.character(org_data[12:13,][which(org_data[12:13,5] == 1), 1])
    ),
    width = "450px"
  )
})
```

### Persona 1

```{r per1-inputs}
# Naming
textInput(
  "per1_name",
  label = "Persona Name:",
  value = "Persona 1",
  placeholder = "Enter Persona Name",
  width = "450px"
)

# Mediums to follow news
renderUI({
  per_data = persona_data()
  selectInput(
    "per1_news_medium",
    label = "Medium to follow news:",
    choices = c(
      "TV",
      "Print",
      "Online (not social media)",
      "Social media",
      "Radio",
      "Email newsletter",
      "News app"
    ),
    multiple = TRUE,
    # selected = c("TV", "Print", "Social media"),
    selected = deframe(per_data[6:12,][which(per_data[6:12,2] == 1), 1]),
    width = "450px"
  )
})

# Gender
renderUI({
  per_data = persona_data()
  selectInput(
    "per1_gender",
    label = "Gender:",
    choices = c(
      "Male",
      "Female",
      "Transgender",
      "Prefer not to say",
      "Other gender"
    ),
    # selected = "Male",
    selected = ifelse(
      sum(per_data[90:93,2]) == 0, "Male",
      as.character(per_data[90:93,][which(per_data[90:93,2] == 1), 1])
    ),
    width = "450px"
  )
})

# Marital status
renderUI({
  per_data = persona_data()
  selectInput(
    "per1_marital_status",
    label = "Marital Status:",
    choices = c(
      "Married",
      "Widowed",
      "Divorced",
      "Separated",
      "Never married"
    ),
    # selected = "Married",
    selected = ifelse(
      sum(per_data[94:97,2]) == 0, "Married",
      as.character(per_data[94:97,][which(per_data[94:97,2] == 1), 1])
    ),
    width = "450px"
  )
})

# Education
renderUI({
  per_data = persona_data()
  selectInput(
    "per1_education",
    label = "Education:",
    choices = c(
      "Less than high school",
      "High school graduate",
      "Some college",
      "2 year degree",
      "4 year degree",
      "Graduate or professional degree",
      "Doctorate"
    ),
    # selected = "2 year degree",
    selected = ifelse(
      sum(per_data[98:103,2]) == 0, "Less than high school",
      as.character(per_data[98:103,][which(per_data[98:103,2] == 1), 1])
    ),
    width = "450px"
  )
})

# Income
renderUI({
  per_data = persona_data()
  selectInput(
    "per1_income",
    label = "Income:",
    choices = c('Less than median of $61,372', 'More than median of $61,372'),
    # selected = "More than median of $61,372",
    selected = ifelse(
      sum(per_data[104,2]) == 0, "Less than median of $61,372",
      as.character(per_data[104,][which(per_data[104,2] == 1), 1])
    ),
    width = "450px"
  )
})

# Race
renderUI({
  per_data = persona_data()
  selectInput(
    "per1_race",
    label = "Race:",
    choices = c(
      'White',
      'Black or African American',
      'American Indian or Alaskan Native',
      'Asian',
      'Native Hawaiian or Pacific Islander',
      'Other race'
    ),
    multiple = TRUE,
    # selected = "White",
    selected = deframe(per_data[105:110,][which(per_data[105:110,2] == 1), 1]),
    width = "450px"
  )
})

# Age
renderUI({
  per_data = persona_data()
  selectInput(
    "per1_age",
    label = "Age:",
    choices = c('Less than median age of 36', "More than median age of 36"),
    # selected = "Less than median age of 36",
    selected = ifelse(
      sum(per_data[111,2]) == 0, "Less than median age of 36",
      as.character(per_data[111,][which(per_data[111,2] == 1), 1])
    ),
    width = "450px"
  )
})
```

### Persona 2

```{r per2-inputs}
# Naming
textInput(
  "per2_name",
  label = "Persona Name:",
  value = "Persona 2",
  placeholder = "Enter Persona Name",
  width = "450px"
)

# Mediums to follow news
renderUI({
  per_data = persona_data()
  selectInput(
    "per2_news_medium",
    label = "Medium to follow news:",
    choices = c(
      "TV",
      "Print",
      "Online (not social media)",
      "Social media",
      "Radio",
      "Email newsletter",
      "News app"
    ),
    multiple = TRUE,
    # selected = c("TV", "Print", "Social media"),
    selected = deframe(per_data[6:12,][which(per_data[6:12,3] == 1), 1]),
    width = "450px"
  )
})

# Gender
renderUI({
  per_data = persona_data()
  selectInput(
    "per2_gender",
    label = "Gender:",
    choices = c(
      "Male",
      "Female",
      "Transgender",
      "Prefer not to say",
      "Other gender"
    ),
    # selected = "Male",
    selected = ifelse(
      sum(per_data[90:93,3]) == 0, "Male",
      as.character(per_data[90:93,][which(per_data[90:93,3] == 1), 1])
    ),
    width = "450px"
  )
})

# Marital status
renderUI({
  per_data = persona_data()
  selectInput(
    "per2_marital_status",
    label = "Marital Status:",
    choices = c(
      "Married",
      "Widowed",
      "Divorced",
      "Separated",
      "Never married"
    ),
    # selected = "Married",
    selected = ifelse(
      sum(per_data[94:97,3]) == 0, "Married",
      as.character(per_data[94:97,][which(per_data[94:97,3] == 1), 1])
    ),
    width = "450px"
  )
})

# Education
renderUI({
  per_data = persona_data()
  selectInput(
    "per2_education",
    label = "Education:",
    choices = c(
      "Less than high school",
      "High school graduate",
      "Some college",
      "2 year degree",
      "4 year degree",
      "Graduate or professional degree",
      "Doctorate"
    ),
    # selected = "Some college",
    selected = ifelse(
      sum(per_data[98:103,3]) == 0, "Less than high school",
      as.character(per_data[98:103,][which(per_data[98:103,3] == 1), 1])
    ),
    width = "450px"
  )
})

# Income
renderUI({
  per_data = persona_data()
  selectInput(
    "per2_income",
    label = "Income:",
    choices = c('Less than median of $61,372', 'More than median of $61,372'),
    # selected = "More than median of $61,372",
    selected = ifelse(
      sum(per_data[104,3]) == 0, "Less than median of $61,372",
      as.character(per_data[104,][which(per_data[104,3] == 1), 1])
    ),
    width = "450px"
  )
})

# Race
renderUI({
  per_data = persona_data()
  selectInput(
    "per2_race",
    label = "Race:",
    choices = c(
      'White',
      'Black or African American',
      'American Indian or Alaskan Native',
      'Asian',
      'Native Hawaiian or Pacific Islander',
      'Other race'
    ),
    multiple = TRUE,
    # selected = "American Indian or Alaskan Native",
    selected = deframe(per_data[105:110,][which(per_data[105:110,3] == 1), 1]),
    width = "450px"
  )
})

# Age
renderUI({
  per_data = persona_data()
  selectInput(
    "per2_age",
    label = "Age:",
    choices = c('Less than median age of 36', "More than median age of 36"),
    # selected = "Less than median age of 36",
    selected = ifelse(
      sum(per_data[111,3]) == 0, "Less than median age of 36",
      as.character(per_data[111,][which(per_data[111,3] == 1), 1])
    ),
    width = "450px"
  )
})
```

### Persona 3

```{r per3-inputs}
# Naming
textInput(
  "per3_name",
  label = "Persona Name:",
  value = "Persona 3",
  placeholder = "Enter Persona Name",
  width = "450px"
)
# Mediums to follow news
renderUI({
  per_data = persona_data()
  selectInput(
    "per3_news_medium",
    label = "Medium to follow news:",
    choices = c(
      "TV",
      "Print",
      "Online (not social media)",
      "Social media",
      "Radio",
      "Email newsletter",
      "News app"
    ),
    multiple = TRUE,
    # selected = c("TV", "Print", "Social media"),
    selected = deframe(per_data[6:12,][which(per_data[6:12,4] == 1), 1]),
    width = "450px"
  )
})

# Gender
renderUI({
  per_data = persona_data()
  selectInput(
    "per3_gender",
    label = "Gender:",
    choices = c(
      "Male",
      "Female",
      "Transgender",
      "Prefer not to say",
      "Other gender"
    ),
    # selected = "Female",
    selected = ifelse(
      sum(per_data[90:93,4]) == 0, "Male",
      as.character(per_data[90:93,][which(per_data[90:93,4] == 1), 1])
    ),
    width = "450px"
  )
})

# Marital status
renderUI({
  per_data = persona_data()
  selectInput(
    "per3_marital_status",
    label = "Marital Status:",
    choices = c(
      "Married",
      "Widowed",
      "Divorced",
      "Separated",
      "Never married"
    ),
    # selected = "Married",
    selected = ifelse(
      sum(per_data[94:97,4]) == 0, "Married",
      as.character(per_data[94:97,][which(per_data[94:97,4] == 1), 1])
    ),
    width = "450px"
  )
})

# Education
renderUI({
  per_data = persona_data()
  selectInput(
    "per3_education",
    label = "Education:",
    choices = c(
      "Less than high school",
      "High school graduate",
      "Some college",
      "2 year degree",
      "4 year degree",
      "Graduate or professional degree",
      "Doctorate"
    ),
    # selected = "Graduate or professional degree",
    selected = ifelse(
      sum(per_data[98:103,4]) == 0, "Less than high school",
      as.character(per_data[98:103,][which(per_data[98:103,4] == 1), 1])
    ),
    width = "450px"
  )
})

# Income
renderUI({
  per_data = persona_data()
  selectInput(
    "per3_income",
    label = "Income:",
    choices = c('Less than median of $61,372', 'More than median of $61,372'),
    # selected = "More than median of $61,372",
    selected = ifelse(
      sum(per_data[104,4]) == 0, "Less than median of $61,372",
      as.character(per_data[104,][which(per_data[104,4] == 1), 1])
    ),
    width = "450px"
  )
})

# Race
renderUI({
  per_data = persona_data()
  selectInput(
    "per3_race",
    label = "Race:",
    choices = c(
      'White',
      'Black or African American',
      'American Indian or Alaskan Native',
      'Asian',
      'Native Hawaiian or Pacific Islander',
      'Other race'
    ),
    multiple = TRUE,
    # selected = c("Black or African American", "American Indian or Alaskan Native"),
    selected = deframe(per_data[105:110,][which(per_data[105:110,4] == 1), 1]),
    width = "450px"
  )
})

# Age
renderUI({
  per_data = persona_data()
  selectInput(
    "per3_age",
    label = "Age:",
    choices = c('Less than median age of 36', "More than median age of 36"),
    # selected = "Less than median age of 36",
    selected = ifelse(
      sum(per_data[111,4]) == 0, "Less than median age of 36",
      as.character(per_data[111,][which(per_data[111,4] == 1), 1])
    ),
    width = "450px"
  )
})
```

Import
-------------------------------------------------

```{r import}
# Organization configuration import
fileInput(
 "org_update",
 "Import Organization Data",
 accept = c(
   "text/csv",
   "text/comma-separated-values,text/plain",
   ".csv"
 )
)
actionButton(
 "org_button",
 label = "Update Organization Data"
)

# Persona configuration import
fileInput(
  "per_update",
  "Import Persona Data",
  accept = c(
    "text/csv",
    "text/comma-separated-values,text/plain",
    ".csv"
  )
)
actionButton(
  "per_button",
  label = "Update Persona Data"
)


# Use the default configurations if no inputs are provided
organization_data <- reactive({
  if (is.null(input$org_update$datapath)) {
    x <- org_default
  } else {
    req(input$org_button)
    req(input$org_update)
    x <- read_csv(input$org_update$datapath)
  }
})

persona_data <- reactive({
  if (is.null(input$per_update$datapath)) {
    x <- per_default
  } else {
    req(input$per_button)
    req(input$per_update)
    x <- read_csv(input$per_update$datapath)
  }
})
```

Export
--------------------------------------------------

```{r export}
# Render the organization configuration as a table
renderTable({
  org_choice = org_reactive()
  org_choice
})

# Download organization configuration
downloadButton("download_org", label = "Download Organization Data")

downloadHandler(
  filename = function() {
    paste0("org_data_",Sys.time(),".csv")
  },
  content = function(file) {
    write_csv(org_reactive(), file)
  }
)

# Render the persona configuration as a table
renderTable({
  per_choice = per_reactive()
  per_choice
})

# Download persona configuration
downloadButton("download_per", label = "Download Persona Data")

downloadHandler(
  filename = function() {
    paste0("per_data_",Sys.time(),".csv")
  },
  content = function(file) {
    write_csv(per_reactive(), file)
  }
)
```
