---
title: "Results"
author: "Andrew Heiss, Marc Dotson, and Suparna Chaudhry"
date: "Last run: `r format(Sys.time(), '%F')`"
output: 
  html_document:
    code_folding: hide
    pandoc_args:
      - "--default-image-extension=png"
editor_options: 
  chunk_output_type: console
---

# Load data and model output

```{r load-libraries-data, warning=FALSE, message=FALSE}
library(tidyverse)
library(donorheuristics)
library(rstan)
library(bayesplot)
library(tidybayes)
library(bayesm)
library(ggridges)
library(ggraph)
library(ggdag)
library(here)

# General settings
source(here("analysis", "options.R"))

# Make all the randomness reproducible
set.seed(1234)

# Specify the model to load
intercept <- 1 # Intercept-only

# Load and extract data and model output (see model-calibration.R)
if (intercept == 1) {
  run <- read_rds(here::here("analysis", "output", "model_runs", "intercept_noncentered.RDS"))
  data <- run$data
  fit <- run$fit
}
```


# Causal pathway

Our theory and hypotheses are laid out in the causal pathway below. Organizational factors (**O**, or organizational practices like financial disclosure and accountability practices; **I**, or issue area; and **F**, or funding) all influence the decision to donate (**D**). Structural factors like an NGO's relationship with its host government (**G**) also influence donation behavior, but the relationship itself is shaped by both funding and issue area. 

```{r causal-dag, fig.width=13/3, fig.height=2}
node_colors <- tribble(
  ~name, ~type,
  "D", "Outcome",
  "I", "Organizational factor",
  "F", "Organizational factor",
  "O", "Organizational factor",
  "G", "Structural factor"
)

# Set up DAG structure
theory_dag <- dagify(D ~ I + F + O + G,
                     G ~ I + F,
                     outcome = "D",
                     exposure = "C") %>% 
  tidy_dagitty(layout = "dh", seed = 1234) 

# Add node types/colors to DAG data
theory_dag$data <- theory_dag$data %>% 
  left_join(node_colors, by = "name")

# Make DAG plot
plot_dag <- ggplot(theory_dag, aes(x = x, y = y, xend = xend, yend = yend)) +
  geom_dag_point(size = 6, mapping = aes(color = type)) +
  geom_dag_edges(start_cap = circle(4, "mm"),
                 end_cap = circle(4, "mm")) +
  geom_dag_text(size = pts(6), family = "Roboto Condensed", fontface = "bold") +
  scale_dag() +
  theme_ngo() +
  theme(panel.grid = element_blank(),
        panel.border = element_blank(),
        axis.title = element_blank(),
        axis.text = element_blank())

# Show and save plot
plot_dag
ggsave(plot_dag, filename = here("analysis", "output", "figures", "causal-path.pdf"),
       width = 13/3, height = 2, units = "in", device = cairo_pdf)
ggsave(plot_dag, filename = here("analysis", "output", "figures", "causal-path.png"),
       width = 13/3, height = 2, units = "in", type = "cairo", dpi = 300)
```


# Model checking

```{r model-checking}
source(here::here("R", "stan_utility.R"))

# Check for divergences
check_div(fit)

# # Check the effective sample size (not working for a hierarchical model?)
# check_n_eff(fit)
# 
# # Check the Rhat statistic (not working for a hierarchical model?)
# check_rhat(fit)

# Check trace plots
fit %>%
  extract(
    inc_warmup = TRUE,
    permuted = FALSE
  ) %>%
  mcmc_trace(
    regex_pars = "Theta",
    n_warmup = 1000,
    facet_args = list(nrow = 2, labeller = label_parsed)
  )

# colnames(fit$Gammadraw) <- str_c("Gamma[", c(1:ncol(fit$Gammadraw)), ",1]")
# fit$Gammadraw %>%
#   mcmc_trace(
#     n_warmup = 500,
#     facet_args = list(nrow = 5, labeller = label_parsed)
#   )

ggsave(
  "intercept_trace_noncentered.png",
  path = here::here("analysis", "output", "figures"),
  width = 12, height = 6, units = "in"
)
```


# Extract draws

```{r extract-draws}
# Extract posterior draws
draws <- fit %>% 
  spread_draws(Theta[i, j]) %>% 
  ungroup() %>% 
  filter(.iteration > 500)

# colnames(fit$Gammadraw) <- str_c("Gamma[", c(1:ncol(fit$Gammadraw)), ",1]")
# draws <- as_tibble(fit$Gammadraw) %>%
#   mutate(
#     .draw = row_number(),
#     .iteration = row_number()
#   ) %>%
#   gather(key = i, value = Gamma, -c(.draw, .iteration)) %>%
#   separate(col = i, into = c("temp1", "i"), sep = "\\[") %>%
#   separate(col = i, into = c("i", "j"), sep = ",") %>%
#   separate(col = j, into = c("j", "temp2"), sep = "\\]") %>%
#   mutate(
#     .chain = as.integer(1),
#     i = as.integer(i),
#     j = as.integer(j)
#   ) %>%
#   select(.chain, .iteration, .draw, i, j, Gamma) %>%
#   arrange(.iteration) %>%
#   filter(.iteration > 500)

# Save draws
write_rds(draws, here::here("analysis", "output", "posterior_draws", "intercept_noncentered.rds"))
```


# Plot marginals

```{r plot-marginals}
# Plot marginals
level_labels <- c(
  str_c("Organization: ", c("Amnesty International", "Greenpeace", "Oxfam", "Red Cross")),
  str_c("Issue area: ", c("Environment", "Human rights", "Refugee relief")),
  "Financial transparency: Yes",
  "Accountability: Yes",
  str_c("Funding sources: ", c("Funded primarily by a handful of wealthy private donors", "Funded primarily by government grants")),
  str_c("Relationship with host government: ", c("Criticized by government", "Under government crackdown"))
)
draws %>% 
  mutate(
    levels = factor(
      i,
      labels = level_labels
    )
  ) %>%
  ggplot(aes(x = Theta, y = levels)) + 
  geom_halfeyeh(.width = .95) +
  geom_vline(xintercept = 0, color = "grey") +
  labs(y = "Attribute Levels")

# Save plot
ggsave(
  "intercept_marginal-posteriors_noncentered.png",
  path = here::here("analysis", "output", "figures"),
  width = 12, height = 6, units = "in"
)
```


# Original computing environment

<button data-toggle="collapse" data-target="#sessioninfo" class="btn btn-primary btn-md btn-info">Here's what we used the last time we built this page</button>

<div id="sessioninfo" class="collapse">

```{r show-session-info, echo=TRUE, width=100}
writeLines(readLines(file.path(Sys.getenv("HOME"), ".R/Makevars")))

devtools::session_info()
```

</div> 
