---
title: "Analysis and results"
author: "Andrew Heiss, Marc Dotson, and Suparna Chaudhry"
date: "Last run: `r format(Sys.time(), '%F')`"
output: 
  html_document:
    code_folding: hide
    pandoc_args:
      - "--default-image-extension=png"
editor_options: 
  chunk_output_type: console
---

# Load packages

```{r load-packages, warning=FALSE, message=FALSE}
library(tidyverse)
library(donorheuristics)
library(rstan)
library(bayesplot)
library(tidybayes)
library(loo)
library(ggridges)
library(ggraph)
library(ggdag)
library(here)

# General settings
source(here("analysis", "options.R"))

# Make all the randomness reproducible
set.seed(1234)

# Set Stan options
options(mc.cores = parallel::detectCores())
rstan_options(auto_write = TRUE)
```


# Model calibration

After selecting the model we'd like to run, model calibration proceeds as follows. Note that model calibration is run in a separate R script given how long it takes to run each model.

```{r model-calibration, eval=FALSE}
intercept <- 0                            # Intercept-only
public_affairs <- 1                       # Public affairs
political_ideology <- 0                   # Political ideology
social_views <- 0                         # Social views
charity_voluntarism <- 0                  # Charity and voluntarism
demographics <- 0                         # Demographics
public_political <- 0                     # Public affairs + Political ideology
public_political_social <- 0              # + Social views
public_political_social_charity <- 0      # + Charity and voluntarism
public_political_social_charity_demo <- 0 # + Demographics

# Load data and design
final_data <- read_rds(here::here("data", "derived_data", "final_data.rds"))
X <- read_rds(here::here("data", "derived_data", "final_design.rds"))

# Restructure choice data Y
Y <- final_data %>%
  select(contains("Q4")) %>%
  as.matrix()

# Restructure covariate matrix Z
if (intercept == 1) {
  Z <- matrix(data = 1, nrow = dim(X)[1], ncol = 1)
}
if (public_affairs == 1) {
  Z <- final_data %>%
    select(
      Q2.1, Q2.2, Q2.3_1:Q2.3_7, Q2.4, Q5.7 # Public affairs
    )
}
if (political_ideology == 1) {
  Z <- final_data %>%
    select(
      Q5.2 # Political ideology
    )
}
if (social_views == 1) {
  Z <- final_data %>%
    select(
      Q5.6, Q5.11, Q5.8, Q5.9, Q5.10 # Social views
    )
}
if (charity_voluntarism == 1) {
  Z <- final_data %>%
    select(
      Q2.7, Q2.8, Q2.5, Q2.6, Q2.9, Q2.10, Q5.4, Q5.5, Q5.3_1:Q5.3_10 # Charity and voluntarism
    )
}
if (demographics == 1) {
  Z <- final_data %>%
    select(
      Q5.12, Q5.13, Q5.14, Q5.15, Q5.16_1:Q5.16_6, Q5.17 # Demographics
    )
}
if (public_political == 1) {
  Z <- final_data %>%
    select(
      Q2.1, Q2.2, Q2.3_1:Q2.3_7, Q2.4, Q5.7, # Public affairs
      Q5.2                                   # Political ideology
    )
}
if (public_political_social == 1) {
  Z <- final_data %>%
    select(
      Q2.1, Q2.2, Q2.3_1:Q2.3_7, Q2.4, Q5.7, # Public affairs
      Q5.2,                                  # Political ideology
      Q5.6, Q5.11, Q5.8, Q5.9, Q5.10         # Social views
    )
}
if (public_political_social_charity == 1) {
  Z <- final_data %>%
    select(
      Q2.1, Q2.2, Q2.3_1:Q2.3_7, Q2.4, Q5.7,                           # Public affairs
      Q5.2,                                                            # Political ideology
      Q5.6, Q5.11, Q5.8, Q5.9, Q5.10,                                  # Social views
      Q2.7, Q2.8, Q2.5, Q2.6, Q2.9, Q2.10, Q5.4, Q5.5, Q5.3_1:Q5.3_10  # Charity and voluntarism
    )
}
if (public_political_social_charity_demo == 1) {
  Z <- final_data %>%
    select(
      Q2.1, Q2.2, Q2.3_1:Q2.3_7, Q2.4, Q5.7,                           # Public affairs
      Q5.2,                                                            # Political ideology
      Q5.6, Q5.11, Q5.8, Q5.9, Q5.10,                                  # Social views
      Q2.7, Q2.8, Q2.5, Q2.6, Q2.9, Q2.10, Q5.4, Q5.5, Q5.3_1:Q5.3_10, # Charity and voluntarism
      Q5.12, Q5.13, Q5.14, Q5.15, Q5.16_1:Q5.16_6, Q5.17               # Demographics
    )
}

# Replace factor labels with levels
Z <- Z %>%
  mutate_if(is.factor, as.integer) %>%
  mutate_if(is.integer, as.factor)

# Pad the variables names with _
colnames(Z) <- str_c(colnames(Z), "_")

# Use the output of lm to get a dummy-coded version of the covariate matrix Z
Z$y <- matrix(rnorm(nrow(Z)), ncol = 1)
out <- lm(y ~ ., Z, x = TRUE)

# Save out Z as a matrix, including an intercept
Z <- tibble(intercept = rep(1, dim(X)[1])) %>%
  bind_cols(as_tibble(out$x[,-1])) %>%
  as.matrix()

# Specify the data for calibration in a list
data <- list(
  R = dim(X)[1],      # Number of respondents
  S = dim(X)[2],      # Number of choice tasks
  A = dim(X)[3],      # Number of choice alternatives
  I = dim(X)[4],      # Number of (estimable) attribute levels
  J = ncol(Z),        # Number of respondent-level covariates

  Gamma_mean = 0,      # Mean of population-level means
  Gamma_scale = 1,     # Scale of population-level means
  Omega_shape = 5,     # Shape of population-level scale
  tau_mean = 0,        # Mean of population-level scale
  tau_scale = 10,      # Scale of population-level scale

  Y = Y,               # Matrix of observed choices
  X = X,               # Array of experimental designs per choice task
  Z = Z                # Matrix of respondent-level covariates
)

# Run the model and save data and model output
fit <- stan(
  file = here::here("src", "stan_files", "hmnl_noncentered.stan"),
  data = data,
  iter = 10000,
  thin = 5,
  seed = 42
)
run <- list(data = data, fit = fit)
if (intercept == 1) write_rds(run, here::here("analysis", "output", "model_runs", "intercept.rds"))
if (public_affairs == 1) write_rds(run, here::here("analysis", "output", "model_runs", "public_affairs.rds"))
if (political_ideology == 1) write_rds(run, here::here("analysis", "output", "model_runs", "political_ideology.rds"))
if (social_views == 1) write_rds(run, here::here("analysis", "output", "model_runs", "social_views.rds"))
if (charity_voluntarism == 1) write_rds(run, here::here("analysis", "output", "model_runs", "charity_voluntarism.rds"))
if (demographics == 1) write_rds(run, here::here("analysis", "output", "model_runs", "demographics.rds"))
if (public_political == 1) write_rds(run, here::here("analysis", "output", "model_runs", "public_political.rds"))
if (public_political_social == 1) write_rds(run, here::here("analysis", "output", "model_runs", "public_political_social.rds"))
if (public_political_social_charity == 1) write_rds(run, here::here("analysis", "output", "model_runs", "public_political_social_charity.rds"))
if (public_political_social_charity_demo == 1) write_rds(run, here::here("analysis", "output", "model_runs", "public_political_social_charity_demo.rds"))
```

The model is calibrated using a non-centered parameterization of a hierarchical multinomial logit model. Each model passed diagnostics checks, including the absence of divergent transitions, as part of model calibration.

```{stan hmnl-noncentered, output.var="hmnl_noncentered", eval=FALSE}
// Index values, hyperprior values, observations, and covariates.
data {
  int<lower = 1> R;                  // Number of respondents.
  int<lower = 1> S;                  // Number of choice tasks.
  int<lower = 2> A;                  // Number of choice alternatives.
  int<lower = 1> I;                  // Number of observation-level covariates.
  int<lower = 1> J;                  // Number of population-level covariates.

  real Gamma_mean;                   // Mean of population-level means.
  real<lower=0> Gamma_scale;         // Scale of population-level means.
  real<lower=0> Omega_shape;         // Shape of population-level scale.
  real tau_mean;                     // Mean of population-level scale.
  real<lower=0> tau_scale;           // Scale of population-level scale.

  int<lower = 1, upper = A> Y[R, S]; // Matrix of observations.
  matrix[A, I] X[R, S];              // Array of observation-level covariates.
  matrix[R, J] Z;                    // Matrix of population-level covariates.
}

// Parameters and hyperparameters.
parameters {
  matrix[J, I] Gamma;                // Matrix of population-level hyperparameters.
  corr_matrix[I] Omega;              // Population model correlation matrix hyperparameters.
  vector<lower = 0>[I] tau;          // Population model vector of scale hyperparameters.
  matrix[R, I] Delta;                // Matrix of non-centered observation-level parameters.
}

// Deterministic transformation.
transformed parameters {
  // Matrix of centered observation-level parameters.
  matrix[R, I] Beta;

  // Non-centered parameterization.
  for (r in 1:R) {
    Beta[r,] = Z[r,] * Gamma + Delta[r,] * quad_form_diag(Omega, tau);
  }
}

// Hierarchical multinomial logit model.
model {
  // Hyperpriors.
  to_vector(Gamma) ~ normal(Gamma_mean, Gamma_scale);
  Omega ~ lkj_corr(Omega_shape);
  tau ~ normal(tau_mean, tau_scale);

  // Non-centered population model and likelihood.
  for (r in 1:R) {
    Delta[r,] ~ normal(0, 1);
    for (s in 1:S) {
      Y[r, s] ~ categorical_logit(X[r, s] * Beta[r,]');
    }
  }
}

// Generated quantities conditioned on parameter draws.
generated quantities {
  // Compute log likelihood for model fit.
  matrix[R, S] log_lik;
  for (r in 1:R) {
    for (s in 1:S) {
      log_lik[r, s] = categorical_logit_lpmf(Y[r, s] | X[r, s] * Beta[r,]');
    }
  }
}
```


# Compute model fit and extract draws

The following analysis follows specifying the model we'd like to evaluate. Note that the output of the model calibration is too large to push to GitHub, but we can push the draws once we extract them.

## Load model output

```{r load-data-output, warning=FALSE, message=FALSE, eval=FALSE}
# Load all model output
intercept_run <- read_rds(here::here("analysis", "output", "model_runs", "intercept.rds"))
public_affairs_run <- read_rds(here::here("analysis", "output", "model_runs", "public_affairs.rds"))
political_ideology_run <- read_rds(here::here("analysis", "output", "model_runs", "political_ideology.rds"))
social_views_run <- read_rds(here::here("analysis", "output", "model_runs", "social_views.rds"))
charity_voluntarism_run <- read_rds(here::here("analysis", "output", "model_runs", "charity_voluntarism.rds"))
demographics_run <- read_rds(here::here("analysis", "output", "model_runs", "demographics.rds"))
public_political_run <- read_rds(here::here("analysis", "output", "model_runs", "public_political.rds"))
public_political_social_run <- read_rds(here::here("analysis", "output", "model_runs", "public_political_social.rds"))
public_political_social_charity_run <- read_rds(here::here("analysis", "output", "model_runs", "public_political_social_charity.rds"))
public_political_social_charity_demo_run <- read_rds(here::here("analysis", "output", "model_runs", "public_political_social_charity_demo.rds"))
```

## Compute model fit

```{r compute-fit, eval=FALSE}
# Compute fit using PSIS-LOO
intercept_loo <- loo(intercept_run$fit, save_psis = TRUE)
public_affairs_loo <- loo(public_affairs_run$fit, save_psis = TRUE)
political_ideology_loo <- loo(political_ideology_run$fit, save_psis = TRUE)
social_views_loo <- loo(social_views_run$fit, save_psis = TRUE)
charity_voluntarism_loo <- loo(charity_voluntarism_run$fit, save_psis = TRUE)
demographics_loo <- loo(demographics_run$fit, save_psis = TRUE)
public_political_loo <- loo(public_political_run$fit, save_psis = TRUE)
public_political_social_loo <- loo(public_political_social_run$fit, save_psis = TRUE)
public_political_social_charity_loo <- loo(public_political_social_charity_run$fit, save_psis = TRUE)
public_political_social_charity_demo_loo <- loo(public_political_social_charity_demo_run$fit, save_psis = TRUE)

# Compare model fit
loo_compare(intercept_loo, public_affairs_loo, political_ideology_loo, social_views_loo, charity_voluntarism_loo, demographics_loo, public_political_loo, public_political_social_loo, public_political_social_charity_loo, public_political_social_charity_demo_loo)
```

```
        elpd_diff se_diff
model1     0.0       0.0 
model3   -23.5       8.6 
model2   -37.5      12.9 
model6   -54.0      15.6 
model7   -70.2      15.4 
model4   -74.4      16.6 
model8  -163.9      23.6 
model5  -174.4      24.6 
model9  -401.3      38.4 
model10 -518.3      44.6
```

The intercept-only model works best in terms of PSIS-LOO, followed by models with political ideology, public affairs and demographics covariates. While PSIS-LOO doesn't properly account for the specific benefits of a hierarchical model, it suggests that political ideology above all other covariate sets specified, has the most explanatory power.

```{r save-fit, eval=FALSE}
# Create data frame
model_fit <- tibble(model = rep(NA, 10), elpd_loo = rep(NA, 10))

# Extract PSIS-LOO fit
model_fit$model[1] <- "intercept"; model_fit$loo[1] <- intercept_loo$elpd_loo
model_fit$model[2] <- "public_affairs"; model_fit$loo[2] <- public_affairs_loo$elpd_loo
model_fit$model[3] <- "political_ideology"; model_fit$loo[3] <- political_ideology_loo$elpd_loo
model_fit$model[4] <- "social_views"; model_fit$loo[4] <- social_views_loo$elpd_loo
model_fit$model[5] <- "charity_voluntarism"; model_fit$loo[5] <- charity_voluntarism_loo$elpd_loo
model_fit$model[6] <- "demographics"; model_fit$loo[6] <- demographics_loo$elpd_loo
model_fit$model[7] <- "public_political"; model_fit$loo[7] <- public_political_loo$elpd_loo
model_fit$model[8] <- "public_political_social"; model_fit$loo[8] <- public_political_social_loo$elpd_loo
model_fit$model[9] <- "public_political_social_charity"; model_fit$loo[9] <- public_political_social_charity_loo$elpd_loo
model_fit$model[10] <- "public_political_social_charity_demo"; model_fit$loo[10] <- public_political_social_charity_demo_loo$elpd_loo

# Save model output
write_rds(model_fit, here::here("analysis", "output", "model_fit.rds"))
```

## Load model fit and extract and save draws

```{r extract-draws, eval=FALSE}
intercept <- 1                            # Intercept-only
public_affairs <- 0                       # Public affairs
political_ideology <- 0                   # Political ideology
social_views <- 0                         # Social views
charity_voluntarism <- 0                  # Charity and voluntarism
demographics <- 0                         # Demographics
public_political <- 0                     # Public affairs + Political ideology
public_political_social <- 0              # + Social views
public_political_social_charity <- 0      # + Charity and voluntarism
public_political_social_charity_demo <- 0 # + Demographics

# Load and extract data and model output
if (intercept == 1) run <- read_rds(here::here("analysis", "output", "model_runs", "intercept.rds"))
if (public_affairs == 1) run <- read_rds(here::here("analysis", "output", "model_runs", "public_affairs.rds"))
if (political_ideology == 1) run <- read_rds(here::here("analysis", "output", "model_runs", "political_ideology.rds"))
if (social_views == 1) run <- read_rds(here::here("analysis", "output", "model_runs", "social_views.rds"))
if (charity_voluntarism == 1) run <- read_rds(here::here("analysis", "output", "model_runs", "charity_voluntarism.rds"))
if (demographics == 1) run <- read_rds(here::here("analysis", "output", "model_runs", "demographics.rds"))
if (public_political == 1) run <- read_rds(here::here("analysis", "output", "model_runs", "public_political.rds"))
if (public_political_social == 1) run <- read_rds(here::here("analysis", "output", "model_runs", "public_political_social.rds"))
if (public_political_social_charity == 1) run <- read_rds(here::here("analysis", "output", "model_runs", "public_political_social_charity.rds"))
if (public_political_social_charity_demo == 1) run <- read_rds(here::here("analysis", "output", "model_runs", "public_political_social_charity_demo.rds"))
data <- run$data
fit <- run$fit

# Extract posterior draws
draws <- fit %>% 
  spread_draws(Gamma[i, j]) %>% 
  ungroup() %>% 
  filter(.iteration > 500) %>% 
  rename(
    i = j,
    j = i
  )

# Save draws
if (intercept == 1) write_rds(draws, here::here("analysis", "output", "posterior_draws", "intercept.rds"))
if (public_affairs == 1) write_rds(draws, here::here("analysis", "output", "posterior_draws", "public_affairs.rds"))
if (political_ideology == 1) write_rds(draws, here::here("analysis", "output", "posterior_draws", "political_ideology.rds"))
if (social_views == 1) write_rds(draws, here::here("analysis", "output", "posterior_draws", "social_views.rds"))
if (charity_voluntarism == 1) write_rds(draws, here::here("analysis", "output", "posterior_draws", "charity_voluntarism.rds"))
if (demographics == 1) write_rds(draws, here::here("analysis", "output", "posterior_draws", "demographics.rds"))
if (public_political == 1) write_rds(draws, here::here("analysis", "output", "posterior_draws", "public_political.rds"))
if (public_political_social == 1)  write_rds(draws, here::here("analysis", "output", "posterior_draws", "public_political_social.rds"))
if (public_political_social_charity == 1) write_rds(draws, here::here("analysis", "output", "posterior_draws", "public_political_social_charity.rds"))
if (public_political_social_charity_demo == 1) write_rds(draws, here::here("analysis", "output", "posterior_draws", "public_political_social_charity_demo.rds"))
```


# Load draws and plot marginals, contrasts, and heatmaps

Now that we have the draws extracted, we can load draws from the model of interest and plot marginals, contrasts, and heatmaps.

## Load draws and assign labels

```{r load-draws}
intercept <- 0                            # Intercept-only
public_affairs <- 0                       # Public affairs
political_ideology <- 0                   # Political ideology
social_views <- 0                         # Social views
charity_voluntarism <- 0                  # Charity and voluntarism
demographics <- 0                         # Demographics
public_political <- 0                     # Public affairs + Political ideology
public_political_social <- 0              # + Social views
public_political_social_charity <- 1      # + Charity and voluntarism
public_political_social_charity_demo <- 0 # + Demographics

# Load draws
if (intercept == 1) draws <- read_rds(here::here("analysis", "output", "posterior_draws", "intercept.rds"))
if (public_affairs == 1) draws <- read_rds(here::here("analysis", "output", "posterior_draws", "public_affairs.rds"))
if (political_ideology == 1) draws <- read_rds(here::here("analysis", "output", "posterior_draws", "political_ideology.rds"))
if (social_views == 1) draws <- read_rds(here::here("analysis", "output", "posterior_draws", "social_views.rds"))
if (charity_voluntarism == 1) draws <- read_rds(here::here("analysis", "output", "posterior_draws", "charity_voluntarism.rds"))
if (demographics == 1) draws <- read_rds(here::here("analysis", "output", "posterior_draws", "demographics.rds"))
if (public_political == 1) draws <- read_rds(here::here("analysis", "output", "posterior_draws", "public_political.rds"))
if (public_political_social == 1) draws <- read_rds(here::here("analysis", "output", "posterior_draws", "public_political_social.rds"))
if (public_political_social_charity == 1) draws <- read_rds(here::here("analysis", "output", "posterior_draws", "public_political_social_charity.rds"))
if (public_political_social_charity_demo == 1) draws <- read_rds(here::here("analysis", "output", "posterior_draws", "public_political_social_charity_demo.rds"))

# Assign level labels
level_labels <- c(
  str_c("Organization: ", c("Amnesty International", "Greenpeace", "Oxfam", "Red Cross")),
  str_c("Issue area: ", c("Environment", "Human rights", "Refugee relief")),
  "Financial transparency: Yes",
  "Accountability: Yes",
  str_c("Funding sources: ", c("Handful of wealthy private donors", "Government grants")),
  str_c("Relationship with host government: ", c("Criticized", "Under crackdown"))
)

# Assign covariate covariates
public_affairs_labels <- c(
  # *Q2.1*: How often do you follow national news? 
  str_c(
    "Follow national news: ", 
    c("Once a week", "At least once a day")
  ),
  # *Q2.2*: How often do you follow international news? 
  str_c(
    "Follow international news: ", 
    c("Sometimes", "Always")
  ),
  # *Q2.3*: Which mediums do you use to follow news? (Select all that apply.)
  str_c(
    "Medium to follow news: ", 
    c(
      "TV", "Print", "Online (excluding social media)", "Social media", 
      "Radio", "Email newsletters", "News app"
    )
  ),
  # *Q2.4*: How often would you say you follow what's going on in government and public affairs?
  "Follow government and public affairs: Often", 
  # *Q5.7*: Have you ever traveled to a developing country? 
  "Traveled to a developing country: No"
)
political_ideology_labels <- c(
  # *Q5.2*: On a scale of extremely liberal (1) to extremely conservative (7), how would you describe your political views?
  str_c(
    "Liberal to Conservative: ", 
    c(
      "Somewhat liberal", "Slightly liberal", "Moderate",
      "Slightly conservative", "Somewhat conservative", "Extremely conservative"
    )
  )
)
social_views_labels <- c(
  # *Q5.6*: On a scale of no trust (1) to complete trust (7), how much do you trust political institutions and the state?
  str_c(
    "Trust in political institutions: ", 
    c(
      "Very little trust", "Little trust", 
      "Neutral", "Some trust", "A lot of trust", "Complete trust"
    )
  ),
  # *Q5.11*: On a scale of strongly agree (1) to strongly disagree (7), rate your response to the following statement: People should be more charitable towards others in society.
  str_c(
    "People should be more charitable: ", 
    c(
      "Agree", "Somewhat agree", "Neutral", 
      "Somewhat disagree", "Disagree", "Strongly disagree"
    )
  ),
  # *Q5.8*: How often do you attend religious or worship services, not including weddings and funerals?
  str_c(
    "Religious and worship service attendance: ", 
    c("Rarely", "At least once a month")
  ),
  # *Q5.9*: How important is religion in your life?
  "Importance of religion: Important",
  # *Q5.10*: What is your current religion, if any?
  str_c(
    "Religion: ", 
    c(
      "Protestant", "Christian Orthodox", "Jewish", "Muslim", 
      "Sikh", "Hindu", "Buddhist", "Atheist", "Other"
    )
  )
)
charity_voluntarism_labels <- c(
  # *Q2.7*: On a scale of not at all important (1) to essential (7), how important is it for you to trust charities?
  str_c(
    "Importance of trusing charities: ", 
    c(
      "Very unimportant", "Somewhat unimportant", 
      "Neutral", "Somewhat important", "Very important", "Essential"
    )
  ),
  # *Q2.8*: On a scale of no trust at all (1) to complete trust (7), how much do you trust charities?
  str_c(
    "Trust in charities: ", 
    c(
      "Very little trust", "Little trust", 
      "Neutral", "Some trust", "A lot of trust", "Complete trust"
    )
  ),
  # *Q2.5*: How often do you donate to charity (with either cash or in-kind)?
  "Donation frequency: At least once a month",
  # *Q2.6*: How much did you donate to charity last year?
  str_c(
    "Donated last year: ",
    c(
      "$50-$99", "$100-$499", "$500-$999", 
      "$1000-$4,999", "$5000-$9,999", "$10,000+"
    )
  ),
  # *Q2.9*: Have you volunteered in the past 12 months?
  "Volunteered in past 12 months: Yes", 
  # *Q2.10*: How often do you volunteer?
  str_c(
    "Volunteer frequency: ",
    c("Rarely", "More than once a month, less than once a year", "At least once a month")
  ),
  # *Q5.4*: Historically, how involved have you been in activist causes?
  "History of activism: Involved",
  # *Q5.5*: Historically, how involved has your family been in activist causes?
  "History of family activism: Involved",
  # *Q5.3*: Here is a list of different types of voluntary organizations. For each organization, indicate whether you are an active member, an inactive member, or not a member of that type of organization:
  str_c(
    "Church or religious organization: ",
    c("Inactive member", "Active member")
  ),
  str_c(
    "Sport or recreational organization: ",
    c("Inactive member", "Active member")
  ),
  str_c(
    "Art, music, or educational organization: ",
    c("Inactive member", "Active member")
  ),
  str_c(
    "Labor union: ",
    c("Inactive member", "Active member")
  ),
  str_c(
    "Political party: ",
    c("Inactive member", "Active member")
  ),
  str_c(
    "Environmental organization: ",
    c("Inactive member", "Active member")
  ),
  str_c(
    "Professional association: ",
    c("Inactive member", "Active member")
  ),
  str_c(
    "Humanitarian or charitable organization: ",
    c("Inactive member", "Active member")
  ),
  str_c(
    "Consumer organization: ",
    c("Inactive member", "Active member")
  ),
  str_c(
    "Other organization: ",
    c("Inactive member", "Active member")
  )
)
demographics_labels <- c(
  # *Q5.12*: What is your gender?
  str_c(
    "Gender: ", 
    c("Female", "Transgender", "Prefer not to say", "Other")
  ), 
  # *Q5.13*: Are you now married, widowed, divorced, separated, or never married?
  str_c(
    "Marital status: ", 
    c("Widowed", "Divorced", "Separated", "Never married")
  ), 
  # *Q5.14*: What is the highest degree or level of school you have completed?
  str_c(
    "Education: ", 
    c(
      "High school graduate", 
      "Some college", "2 year degree", "4 year degree", 
      "Graduate or professional degree", "Doctorate"
    )
  ), 
  # *Q5.15*: What is your annual household income before taxes?
  "Income: More than median",
  # *Q5.16*: Choose one or more races that you consider yourself to be:
  str_c(
    "Race/ethnicity: ",
    c(
      "White", "Black or African American", "American Indian or Alaska Native", 
      "Asian", "Native Hawaiian or Pacific Islander", "Other"
    )
  ),
  # *Q5.17*: How old are you?
  "Age: More than median"
)
if (public_affairs == 1) covariate_labels <- public_affairs_labels
if (political_ideology == 1) covariate_labels <- political_ideology_labels
if (social_views == 1) covariate_labels <- social_views_labels
if (charity_voluntarism == 1) covariate_labels <- charity_voluntarism_labels
if (demographics == 1) covariate_labels <- demographics_labels
if (public_political == 1) {
  covariate_labels <- c(public_affairs_labels, political_ideology_labels)
}
if (public_political_social == 1) {
  covariate_labels <- c(public_affairs_labels, political_ideology_labels, social_views_labels)
}
if (public_political_social_charity == 1) {
  covariate_labels <- c(
    public_affairs_labels, political_ideology_labels, 
    social_views_labels, charity_voluntarism_labels
  )
}
if (public_political_social_charity_demo == 1) {
  covariate_labels <- c(
    public_affairs_labels, political_ideology_labels, 
    social_views_labels, charity_voluntarism_labels, demographics_labels
  )
}
```

## Plot marginals

```{r plot-marginals}
# Plot marginals
if (intercept == 1) {
  draws %>%
    mutate(
      levels = factor(i, labels = level_labels)
    ) %>%
    ggplot(aes(x = Gamma, y = levels)) +
    stat_halfeye(.width = .95) +
    geom_vline(xintercept = 0, color = "grey") +
    labs(y = "Attribute Levels")
}
if (intercept != 1) {
  draws %>%
    filter(j != 1) %>%
    mutate(
      levels = factor(i, labels = level_labels),
      covariates = factor(j, labels = covariate_labels)
    ) %>%
    ggplot(aes(x = Gamma, y = covariates)) +
      stat_halfeye(.width = .95) +
      geom_vline(xintercept = 0, color = "white") +
      labs(y = "Covariates") +
      facet_wrap(~ levels, ncol = 5)
}

# Save plot
if (intercept == 1) file_name <- paste("marginal-posteriors_intercept.png")
if (public_affairs == 1) file_name <- paste("marginal-posteriors_public-affairs.png")
if (political_ideology == 1) file_name <- paste("marginal-posteriors_political-ideology.png")
if (social_views == 1) file_name <- paste("marginal-posteriors_social-views.png")
if (charity_voluntarism == 1) file_name <- paste("marginal-posteriors_charity-voluntarism.png")
if (demographics == 1) file_name <- paste("marginal-posteriors_demographics.png")
if (public_political == 1) file_name <- paste("marginal-posteriors_public-political.png")
if (public_political_social == 1) file_name <- paste("marginal-posteriors_public-political-social.png")
if (public_political_social_charity == 1) file_name <- paste("marginal-posteriors_public-political-social-charity.png")
if (public_political_social_charity_demo == 1) file_name <- paste("marginal-posteriors_public-political-social-charity-demos.png")
if (intercept == 1) width_length <- c(10, 10)
if (intercept != 1) width_length <- c(20, 20)
if (public_political_social_charity == 1) width_length <- c(20, 30)
if (public_political_social_charity_demo == 1) width_length <- c(20, 30)
ggsave(
  file_name,
  path = here::here("analysis", "output", "figures"),
  width = width_length[1],
  height = width_length[2],
  units = "in"
)
```

## Plot contrasts

```{r plot-contrasts}

```

## Plot heatmaps

Instead of plotting marginals or contrasts, we can use a heatmap to identify where there are significant differences in the non-intercept models, which can then be narrowed down using the marginal plots.

```{r plot-heatmaps}
if (public_affairs == 1) plot_title <- paste("Public Affairs")
if (political_ideology == 1) plot_title <- paste("Political Ideology")
if (social_views == 1) plot_title <- paste("Social Views")
if (charity_voluntarism == 1) plot_title <- paste("Covariates related to charity and voluntarism")
if (demographics == 1) plot_title <- paste("Demographics")
if (public_political == 1) plot_title <- paste("Public Affairs and Political Ideology")
if (public_political_social == 1) plot_title <- paste("Public Affairs, Political Ideology, and Social Views")
if (public_political_social_charity == 1) plot_title <- paste("Public Affairs, Political Ideology, Social Views, and Charity and Voluntarism")
if (public_political_social_charity_demo == 1) plot_title <- paste("Public Affairs, Political Ideology, Social Views, Charity and Voluntarism, and Demographics")

if (charity_voluntarism == 1) {
  j_labels <- tribble(
    ~j, ~j_label,
    2, "Importance of trusting charities", 
    3, "Trust charities", 
    4, "Frequency of donation", 
    5, "Amount of donation", 
    6, "Volunteered", 
    7, "Volunteer frequency", 
    8, "Personal involvement in activism", 
    9, "Family involvement in activism", 
    10, "Membership in church", 
    11, "Membership in sports", 
    12, "Membership in art, music, or educational organization", 
    13, "Membership in labor union", 
    14, "Membership in political party", 
    15, "Membership in envrionmental organization", 
    16, "Membership in professional association", 
    17, "Membership in humanitarian organization", 
    18, "Membership in consumer organization", 
    19, "Membership in other organization"
  ) %>% 
    mutate(j_label = fct_inorder(j_label))
}

if (intercept != 1) {
  # Posterior means.
  posterior_means <- draws %>% 
    filter(j != 1) %>% 
    left_join(j_labels, by = "j") %>% 
    left_join(level_lookup, by = "i") %>% 
    mutate(
      levels = factor(i, labels = level_labels), 
      # covariates = factor(j, labels = covariate_labels)
      covariates = factor(j, labels = 1:length(covariate_labels))
    ) %>% 
    group_by(category, attribute, j_label) %>% 
    summarize(
      mean = mean(Gamma),
      ci_lower = quantile(Gamma, .025),
      ci_upper = quantile(Gamma, .975),
      gt_zero = if_else(ci_lower > 0 & ci_upper > 0, 1, 0),
      lt_zero = if_else(ci_lower < 0 & ci_upper < 0, -1, 0)
    )
  
  # Heatmap of Gamma matrix.
  plot_heatmap <- posterior_means %>% 
    mutate(
      gt_lt_zero = gt_zero + lt_zero,
      Coefficients = factor(
        gt_lt_zero, 
        levels = -1:1,
        labels = c("Negative", "Not Significant", "Positive"))
    ) %>% 
    ggplot(aes(x = j_label, y = attribute, fill = Coefficients)) +
    geom_tile(color = "white", size = 0.25) +
    # scale_fill_brewer(palette = "Blues") +
    scale_fill_manual(values = c(clrs$orange, "grey80", clrs$olive)) +
    scale_x_discrete(expand = c(0.001, 0.001)) +
    scale_y_discrete(expand = c(0.001, 0.001)) +
    # guides(fill = guide_legend(override.aes = list(key.height = 0.5, key.width = 0.5))) +
    guides(fill = guide_legend(keywidth = 0.5, keyheight = 0.5)) +
    theme_ngo(base_size = 14) +
    theme(axis.text.x = element_text(angle = 45, hjust = 1), 
          legend.position = "bottom",
          strip.placement = "outside") +
    labs(
      title = plot_title,
      x = "Covariates",
      y = "Attribute Levels"
    ) + 
    # facet_wrap(~ category, ncol = 1, scales = "free_y")
    facet_grid(vars(category), scales = "free_y", space = "free_y")
}

plot_heatmap
ggsave(plot_heatmap, filename = here("analysis", "output", "figures", "q2-heatmap.pdf"),
       width = 26/3, height = 6.5, units = "in", device = cairo_pdf)
ggsave(plot_heatmap, filename = here("analysis", "output", "figures", "q2-heatmap.png"),
       width = 26/3, height = 6.5, units = "in", type = "cairo", dpi = 300)

# Save plot
if (public_affairs == 1) file_name <- paste("public-affairs_coefficient-matrix.png")
if (political_ideology == 1) file_name <- paste("political-ideology_coefficient-matrix.png")
if (social_views == 1) file_name <- paste("social-views_coefficient-matrix.png")
if (charity_voluntarism == 1) file_name <- paste("charity-voluntarism_coefficient-matrix.png")
if (demographics == 1) file_name <- paste("demographics_coefficient-matrix.png")
if (public_political == 1) file_name <- paste("public-political_coefficient-matrix.png")
if (public_political_social == 1) file_name <- paste("public-political-social_coefficient-matrix.png")
if (public_political_social_charity == 1) file_name <- paste("public-political-social-charity_coefficient-matrix.png")
if (public_political_social_charity_demo == 1) file_name <- paste("public-political-social-charity-demos_coefficient-matrix.png")
ggsave(
  file_name,
  path = here::here("analysis", "output", "figures"),
  width = 12,
  height = 6,
  units = "in"
)
```

# Original computing environment

<button data-toggle="collapse" data-target="#sessioninfo" class="btn btn-primary btn-md btn-info">Here's what we used the last time we built this page</button>

<div id="sessioninfo" class="collapse">

```{r show-session-info, echo=TRUE, width=100}
writeLines(readLines(file.path(Sys.getenv("HOME"), ".R/Makevars")))

devtools::session_info()
```

</div> 
