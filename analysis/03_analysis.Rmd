---
title: "Results"
author: "Andrew Heiss, Marc Dotson, and Suparna Chaudhry"
date: "Last run: `r format(Sys.time(), '%F')`"
output: 
  html_document:
    code_folding: hide
    pandoc_args:
      - "--default-image-extension=png"
editor_options: 
  chunk_output_type: console
---

# Load data and model output

```{r load-libraries-data, warning=FALSE, message=FALSE}
library(tidyverse)
library(donorheuristics)
library(rstan)
library(bayesplot)
library(tidybayes)
library(bayesm)
library(ggridges)
library(ggraph)
library(ggdag)
library(here)

# General settings
source(here("analysis", "options.R"))

# Make all the randomness reproducible
set.seed(1234)

intercept <- 0                            # Intercept-only
public_affairs <- 0                       # Public affairs
political_ideology <- 0                   # Political ideology
social_views <- 0                         # Social views
charity_voluntarism <- 0                  # Charity and voluntarism
demographics <- 0                         # Demographics
public_political <- 0                     # Public affairs + Political ideology
public_political_social <- 0              # + Social views
public_political_social_charity <- 0      # + Charity and voluntarism
public_political_social_charity_demo <- 1 # + Demographics

# Load and extract data and model output (see model-calibration.R)
if (intercept == 1) run <- read_rds(here::here("analysis", "output", "model_runs", "intercept_noncentered.RDS"))
if (public_affairs == 1) run <- read_rds(here::here("analysis", "output", "model_runs", "public_affairs.rds"))
if (political_ideology == 1) run <- read_rds(here::here("analysis", "output", "model_runs", "political_ideology.rds"))
if (social_views == 1) run <- read_rds(here::here("analysis", "output", "model_runs", "social_views.rds"))
if (charity_voluntarism == 1) run <- read_rds(here::here("analysis", "output", "model_runs", "charity_voluntarism.rds"))
if (demographics == 1) run <- read_rds(here::here("analysis", "output", "model_runs", "demographics.rds"))
if (public_political == 1) run <- read_rds(here::here("analysis", "output", "model_runs", "public_political.rds"))
if (public_political_social == 1) run <- read_rds(here::here("analysis", "output", "model_runs", "public_political_social.rds"))
if (public_political_social_charity == 1) run <- read_rds(here::here("analysis", "output", "model_runs", "public_political_social_charity.rds"))
if (public_political_social_charity_demo == 1) run <- read_rds(here::here("analysis", "output", "model_runs", "public_political_social_charity_demo.rds"))
data <- run$data
fit <- run$fit
```


# Causal pathway

Our theory and hypotheses are laid out in the causal pathway below. Organizational factors (**O**, or organizational practices like financial disclosure and accountability practices; **I**, or issue area; and **F**, or funding) all influence the decision to donate (**D**). Structural factors like an NGO's relationship with its host government (**G**) also influence donation behavior, but the relationship itself is shaped by both funding and issue area. 

```{r causal-dag, fig.width=13/3, fig.height=2}
node_colors <- tribble(
  ~name, ~type,
  "D", "Outcome",
  "I", "Organizational factor",
  "F", "Organizational factor",
  "O", "Organizational factor",
  "G", "Structural factor"
)

# Set up DAG structure
theory_dag <- dagify(D ~ I + F + O + G,
                     G ~ I + F,
                     outcome = "D",
                     exposure = "C") %>% 
  tidy_dagitty(layout = "dh", seed = 1234) 

# Add node types/colors to DAG data
theory_dag$data <- theory_dag$data %>% 
  left_join(node_colors, by = "name")

# Make DAG plot
plot_dag <- ggplot(theory_dag, aes(x = x, y = y, xend = xend, yend = yend)) +
  geom_dag_point(size = 6, mapping = aes(color = type)) +
  geom_dag_edges(start_cap = circle(4, "mm"),
                 end_cap = circle(4, "mm")) +
  geom_dag_text(size = pts(6), family = "Roboto Condensed", fontface = "bold") +
  scale_dag() +
  theme_ngo() +
  theme(panel.grid = element_blank(),
        panel.border = element_blank(),
        axis.title = element_blank(),
        axis.text = element_blank())

# Show and save plot
plot_dag
ggsave(plot_dag, filename = here("analysis", "output", "figures", "causal-path.pdf"),
       width = 13/3, height = 2, units = "in", device = cairo_pdf)
ggsave(plot_dag, filename = here("analysis", "output", "figures", "causal-path.png"),
       width = 13/3, height = 2, units = "in", type = "cairo", dpi = 300)
```


# Model checking

```{r model-checking}
source(here::here("R", "stan_utility.R"))

# Check for divergences
check_div(fit)

# # Check the effective sample size (not working for a hierarchical model?)
# check_n_eff(fit)
# 
# # Check the Rhat statistic (not working for a hierarchical model?)
# check_rhat(fit)

# Check trace plots (SUBSET?)
fit %>%
  extract(
    inc_warmup = TRUE,
    permuted = FALSE
  ) %>%
  mcmc_trace(
    regex_pars = "Theta",
    n_warmup = 1000,
    facet_args = list(
      nrow = round((data$L * data$C)/7), 
      labeller = label_parsed
    )
  )

# ggsave(
#   "intercept_trace_noncentered.png",
#   path = here::here("analysis", "output", "figures"),
#   width = 12, height = 6, units = "in"
# )
```


# Extract draws

```{r extract-draws}
# Extract posterior draws
draws <- fit %>% 
  spread_draws(Theta[i, j]) %>% 
  ungroup() %>% 
  filter(.iteration > 500)

# Save draws
if (intercept == 1) write_rds(draws, here::here("analysis", "output", "posterior_draws", "intercept_noncentered.rds"))
if (public_affairs == 1) write_rds(draws, here::here("analysis", "output", "posterior_draws", "public_affairs.rds"))
if (political_ideology == 1) write_rds(draws, here::here("analysis", "output", "posterior_draws", "political_ideology.rds"))
if (social_views == 1) write_rds(draws, here::here("analysis", "output", "posterior_draws", "social_views.rds"))
if (charity_voluntarism == 1) write_rds(draws, here::here("analysis", "output", "posterior_draws", "charity_voluntarism.rds"))
if (demographics == 1) write_rds(draws, here::here("analysis", "output", "posterior_draws", "demographics.rds"))
if (public_political == 1) write_rds(draws, here::here("analysis", "output", "posterior_draws", "public_political.rds"))
if (public_political_social == 1)  write_rds(draws, here::here("analysis", "output", "posterior_draws", "public_political_social.rds"))
if (public_political_social_charity == 1) write_rds(draws, here::here("analysis", "output", "posterior_draws", "public_political_social_charity.rds"))
if (public_political_social_charity_demo == 1) write_rds(draws, here::here("analysis", "output", "posterior_draws", "public_political_social_charity_demo.rds"))
```


# Plot marginals

```{r plot-marginals}
# Plot marginals
level_labels <- c(
  str_c("Organization: ", c("Amnesty International", "Greenpeace", "Oxfam", "Red Cross")),
  str_c("Issue area: ", c("Environment", "Human rights", "Refugee relief")),
  "Financial transparency: Yes",
  "Accountability: Yes",
  str_c("Funding sources: ", c("Funded primarily by a handful of wealthy private donors", "Funded primarily by government grants")),
  str_c("Relationship with host government: ", c("Criticized by government", "Under government crackdown"))
)

# Covariates...

draws %>% 
  mutate(
    levels = factor(
      i,
      labels = level_labels
    )
  ) %>%
  ggplot(aes(x = Theta, y = levels)) + 
  geom_halfeyeh(.width = .95) +
  geom_vline(xintercept = 0, color = "grey") +
  labs(y = "Attribute Levels")

# Save plot
ggsave(
  "intercept_marginal-posteriors_noncentered.png",
  path = here::here("analysis", "output", "figures"),
  width = 12, height = 6, units = "in"
)
```


# Original computing environment

<button data-toggle="collapse" data-target="#sessioninfo" class="btn btn-primary btn-md btn-info">Here's what we used the last time we built this page</button>

<div id="sessioninfo" class="collapse">

```{r show-session-info, echo=TRUE, width=100}
writeLines(readLines(file.path(Sys.getenv("HOME"), ".R/Makevars")))

devtools::session_info()
```

</div> 
